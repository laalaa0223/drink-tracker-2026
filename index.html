<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 æ‰‹æ–å¤§ä½œæˆ° âœ¨</title>
    <!-- 1. è¼‰å…¥ Tailwind èˆ‡ åœ–æ¨™ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide-react"></script>
    <!-- 2. è¼‰å…¥ React -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- 3. è¼‰å…¥ Firebase ç›¸å®¹ç‰ˆ (æœ€ç©©å®š) -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <!-- 4. è¼‰å…¥ Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #FFF9FB; }
        .heart-beat { animation: beat 1.5s ease-in-out infinite; }
        @keyframes beat { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
    </style>
</head>
<body>
    <div id="root">
        <div style="display:flex; justify-content:center; align-items:center; height:100vh; color:#FFB6C1; font-weight:bold;">
            æ­£åœ¨å•Ÿå‹•è³‡æ–™åº«... è«‹ç¨å€™
        </div>
    </div>

    <script type="text/babel">
        // ğŸ”´ è«‹å°‡ä½ çš„é‡‘é‘°å†æ¬¡ç¢ºèªå¡«å…¥ä¸‹æ–¹ ğŸ”´
        const firebaseConfig = {
  apiKey: "AIzaSyCJ773ohTtllA3UeUwYqVwv-68Dhu2v0fs",
  authDomain: "my-drink-tracker.firebaseapp.com",
  projectId: "my-drink-tracker",
  storageBucket: "my-drink-tracker.firebasestorage.app",
  messagingSenderId: "637285768502",
  appId: "1:637285768502:web:2b192cbc10a046ec47a797",
  measurementId: "G-21055EVPQL"
};

        const { useState, useEffect, useMemo } = React;

        const App = () => {
            const [user, setUser] = useState(null);
            const [records, setRecords] = useState({});
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [selectedDate, setSelectedDate] = useState(null);
            const [currentMonth, setCurrentMonth] = useState(new Date(2026, 0, 1));
            const [loading, setLoading] = useState(true);

            // åˆå§‹åŒ– Firebase
            useEffect(() => {
                try {
                    if (!firebase.apps.length) {
                        firebase.initializeApp(firebaseConfig);
                    }
                    const auth = firebase.auth();
                    auth.signInAnonymously().catch(err => console.error("åŒ¿åç™»å…¥å¤±æ•—", err));
                    
                    const unsubscribe = auth.onAuthStateChanged(u => {
                        setUser(u);
                        setLoading(false);
                    });
                    return () => unsubscribe();
                } catch (err) {
                    document.body.innerHTML = `<div style="padding:20px; color:red;"><h3>Firebase åˆå§‹åŒ–éŒ¯èª¤</h3><p>${err.message}</p></div>`;
                }
            }, []);

            // ç›£è½è³‡æ–™åº«
            useEffect(() => {
                if (!user) return;
                const db = firebase.firestore();
                const docRef = db.collection('artifacts').doc('drink-2026').collection('users').doc(user.uid).doc('main');
                
                const unsubscribe = docRef.onSnapshot(docSnap => {
                    if (docSnap.exists) {
                        setRecords(docSnap.data().records || {});
                    }
                }, err => console.error("Firestore ç›£è½å¤±æ•—", err));
                return () => unsubscribe();
            }, [user]);

            const syncData = async (newRecords) => {
                setRecords(newRecords);
                if (!user) return;
                const db = firebase.firestore();
                try {
                    const docRef = db.collection('artifacts').doc('drink-2026').collection('users').doc(user.uid).doc('main');
                    await docRef.set({ records: newRecords }, { merge: true });
                } catch (e) { console.error(e); }
            };

            const analytics = useMemo(() => {
                const shopMap = {}; const itemMap = {};
                let mC = 0; let yC = 0;
                const targetM = currentMonth.getMonth() + 1;
                Object.entries(records).forEach(([date, list]) => {
                    const [y, m] = date.split('-').map(Number);
                    if (y === 2026) {
                        yC += list.length;
                        if (m === targetM) mC += list.length;
                        list.forEach(i => {
                            if (i.shop) shopMap[i.shop] = (shopMap[i.shop] || 0) + 1;
                            if (i.item) itemMap[i.item] = (itemMap[i.item] || 0) + 1;
                        });
                    }
                });
                const getTop = (map) => Object.entries(map).sort((a,b)=>b[1]-a[1])[0]?.[0] || "å°šç„¡è³‡æ–™";
                return { mC, yC, topShop: getTop(shopMap), topItem: getTop(itemMap) };
            }, [records, currentMonth]);

            const { firstDay, totalDays } = useMemo(() => ({
                firstDay: new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1).getDay(),
                totalDays: new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0).getDate()
            }), [currentMonth]);

            if (loading) return <div className="h-screen flex items-center justify-center text-pink-300 font-bold">é€£ç·šä¸­...</div>;

            return (
                <div className="max-w-md mx-auto p-4">
                    {/* Header */}
                    <header className="bg-gradient-to-br from-pink-200 to-blue-100 rounded-[2.5rem] shadow-lg p-6 mb-4 text-center text-white border-4 border-white">
                        <h1 className="text-2xl font-black italic">2026 æ‰‹æ–å¤§ä½œæˆ°</h1>
                        <p className="text-[10px] font-bold opacity-70">BEVERAGE LOG</p>
                    </header>

                    {/* ç½®é ‚åˆ†æ */}
                    <div className="grid grid-cols-2 gap-3 mb-4">
                        <div className="bg-white p-4 rounded-[2rem] shadow-sm border border-orange-50 flex flex-col items-center">
                            <lucide.Store size={18} className="text-orange-300 mb-1" />
                            <span className="text-[9px] font-black text-orange-200 uppercase">æœ€æ„›åº—å®¶</span>
                            <p className="text-xs font-black text-slate-700 truncate w-full text-center">{analytics.topShop}</p>
                        </div>
                        <div className="bg-white p-4 rounded-[2rem] shadow-sm border border-purple-50 flex flex-col items-center">
                            <lucide.CupSoda size={18} className="text-purple-300 mb-1" />
                            <span className="text-[9px] font-black text-purple-200 uppercase">æœ€æ„›å“é …</span>
                            <p className="text-xs font-black text-slate-700 truncate w-full text-center">{analytics.topItem}</p>
                        </div>
                    </div>

                    {/* è¨ˆæ•¸å™¨ */}
                    <div className="grid grid-cols-2 gap-3 mb-6">
                        <div className="bg-white p-5 rounded-[2rem] shadow-sm border border-pink-50">
                            <span className="text-[9px] font-black text-pink-300">{currentMonth.getMonth()+1}æœˆæ¯æ•¸</span>
                            <div className="flex items-end gap-1"><span className="text-2xl font-black">{analytics.mC}</span><span className="text-[10px] mb-1">æ¯</span></div>
                        </div>
                        <div className="bg-white p-5 rounded-[2rem] shadow-sm border border-blue-50">
                            <span className="text-[9px] font-black text-blue-300">å¹´åº¦ç¸½è¨ˆ</span>
                            <div className="flex items-end gap-1"><span className="text-2xl font-black">{analytics.yC}</span><span className="text-[10px] mb-1">æ¯</span></div>
                        </div>
                    </div>

                    {/* æ—¥æ›†å°èˆª */}
                    <div className="flex justify-between items-center mb-4 px-2 font-black text-slate-600">
                        <button onClick={() => setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth()-1, 1))}><lucide.ChevronLeft/></button>
                        <span>{currentMonth.getFullYear()} / {currentMonth.getMonth()+1}</span>
                        <button onClick={() => setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth()+1, 1))}><lucide.ChevronRight/></button>
                    </div>

                    {/* æ—¥æ›† */}
                    <div className="bg-white rounded-[2.5rem] p-4 shadow-md border border-pink-50 grid grid-cols-7 gap-1">
                        {['S','M','T','W','T','F','S'].map(d => <div key={d} className="text-center text-[10px] font-black text-pink-200 py-1">{d}</div>)}
                        {Array.from({ length: firstDay }).map((_, i) => <div key={i} />)}
                        {Array.from({ length: totalDays }).map((_, i) => {
                            const d = i + 1;
                            const key = `2026-${currentMonth.getMonth()+1}-${d}`;
                            const count = (records[key] || []).length;
                            return (
                                <div key={d} onClick={() => { setSelectedDate(key); setIsModalOpen(true); }} className={`h-14 rounded-2xl flex flex-col items-center justify-center cursor-pointer ${count > 0 ? 'bg-pink-50' : ''}`}>
                                    <span className={`text-[10px] font-bold ${count > 0 ? 'text-pink-400' : 'text-slate-300'}`}>{d}</span>
                                    <div className="flex flex-wrap gap-0.5 mt-1">
                                        {Array.from({ length: count }).map((_, idx) => <lucide.Heart key={idx} size={6} className="text-pink-400 fill-pink-400 heart-beat" />)}
                                    </div>
                                </div>
                            );
                        })}
                    </div>

                    {/* å½ˆçª—å…§å®¹ */}
                    {isModalOpen && (
                        <div className="fixed inset-0 z-50 bg-black/20 backdrop-blur-sm flex items-end justify-center p-4">
                            <div className="bg-white w-full max-w-md rounded-[3rem] p-6 max-h-[80vh] overflow-y-auto">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="font-black text-slate-700">{selectedDate} ç´€éŒ„</h2>
                                    <button onClick={() => setIsModalOpen(false)} className="bg-slate-100 p-2 rounded-full"><lucide.X size={16}/></button>
                                </div>
                                {(records[selectedDate] || []).map(drink => (
                                    <div key={drink.id} className="p-4 bg-slate-50 rounded-3xl mb-4 relative">
                                        <button onClick={() => {
                                            const newList = records[selectedDate].filter(i => i.id !== drink.id);
                                            syncData({...records, [selectedDate]: newList});
                                        }} className="absolute top-4 right-4 text-slate-300"><lucide.Trash2 size={14}/></button>
                                        <div className="grid grid-cols-2 gap-2 mb-2">
                                            <input placeholder="åº—å®¶" value={drink.shop} onChange={e => {
                                                const newList = records[selectedDate].map(i => i.id === drink.id ? {...i, shop: e.target.value} : i);
                                                syncData({...records, [selectedDate]: newList});
                                            }} className="p-2 rounded-xl text-xs font-bold border-none bg-white" />
                                            <input placeholder="å“é …" value={drink.item} onChange={e => {
                                                const newList = records[selectedDate].map(i => i.id === drink.id ? {...i, item: e.target.value} : i);
                                                syncData({...records, [selectedDate]: newList});
                                            }} className="p-2 rounded-xl text-xs font-bold border-none bg-white" />
                                        </div>
                                    </div>
                                ))}
                                <button onClick={() => {
                                    const newList = [...(records[selectedDate] || []), { id: Date.now(), shop:'', item:'' }];
                                    syncData({...records, [selectedDate]: newList});
                                }} className="w-full py-4 border-2 border-dashed border-pink-100 rounded-3xl text-pink-200 font-bold">+ æ–°å¢ç´€éŒ„</button>
                                <button onClick={() => setIsModalOpen(false)} className="w-full bg-pink-400 text-white font-black py-4 rounded-[2rem] mt-4 shadow-lg">å„²å­˜ä¸¦é—œé–‰</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
